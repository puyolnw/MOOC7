# การแก้ไขปัญหาระบบ Credit Bank

## ปัญหาที่พบและแนวทางแก้ไข

### 1. ไม่สามารถกดถัดไปยังบทเรียนต่อไปโดยตรงได้

**ปัญหา:** ต้องกดไปที่ sidebar ในส่วนหน้าเรียน

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Courses/Learning.js` - เพิ่ม endpoint สำหรับการนำทางไปบทเรียนถัดไป
- `routes/Courses/Lessons.js` - ปรับปรุงฟังก์ชัน `updateSubjectProgress` 

**Database:**
- เพิ่ม column `next_lesson_id` ใน table `lessons`
- ปรับปรุง query สำหรับการค้นหาบทเรียนถัดไป

**แนวทางแก้ไข:**
```sql
-- เพิ่ม column สำหรับลำดับบทเรียน
ALTER TABLE lessons ADD COLUMN order_number INTEGER;

-- สร้าง API endpoint ใหม่
POST /api/learn/lesson/:lessonId/next
```

**API ที่ต้องเพิ่ม:**
1. `GET /api/learn/subject/:subjectId/lessons/order` - ดึงลำดับบทเรียนทั้งหมด
2. `POST /api/learn/lesson/:lessonId/complete-and-next` - เรียนจบและไปบทถัดไป

---

### 2. ไม่สามารถส่งคำตอบแบบที่มีไฟล์ได้

**ปัญหา:** เมื่อกดส่งแล้วไม่ขึ้นว่า "รอตรวจ" ที่ sidebar

**ระบบ Special Quiz ทำงานได้แล้ว - แค่ต้องแก้การแสดงผลเท่านั้น**

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Courses/SpecialQuiz.js` (บรรทัด 156-216) - ตรวจสอบการอัปเดตสถานะ `awaiting_review`
- Frontend components - แก้การแสดงสถานะ "รอตรวจ" ใน sidebar

**Database:**
- ตรวจสอบ field `awaiting_review` ใน `quiz_progress` ว่าอัปเดตถูกต้องหรือไม่

**แนวทางแก้ไข:**
```javascript
// ตรวจสอบใน SpecialQuiz.js ว่ามีการอัปเดตสถานะหรือไม่
await client.query(`
  UPDATE quiz_progress 
  SET awaiting_review = true, 
      completed = false, 
      updated_at = NOW()
  WHERE user_id = $1 AND quiz_id = $2
`, [userId, quizId]);

// และตรวจสอบว่า Frontend ดึงข้อมูลสถานะนี้มาแสดงหรือไม่
```

---

### 3. ไม่สามารถส่งคำตอบแบบทดสอบได้ (ที่มีทั้งปรนัยและอัตนัย)

**ปัญหา:** แบบทดสอบที่มีทั้งอัตนัยและปรนัยรวมกัน ไม่ขึ้นรอตรวจ 

**แก้ไขโดย:** ห้ามให้มีแบบทดสอบที่มีทั้งอัตนัยและปรนัยนะ (ตามที่ระบุ)

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Courses/Questions.js` - เพิ่มการตรวจสอบเมื่อเพิ่มคำถามในแบบทดสอบ
- Frontend - เพิ่ม validation ป้องกันการสร้างแบบทดสอบผสม

**Database:**
- เพิ่ม constraint ใน table `quiz_questions` ป้องกันการผสมประเภทคำถาม

**แนวทางแก้ไข:**
```sql
-- สร้าง function ตรวจสอบประเภทคำถามในแบบทดสอบ
CREATE OR REPLACE FUNCTION check_quiz_question_types()
RETURNS TRIGGER AS $$
BEGIN
  -- ตรวจสอบว่าแบบทดสอบมีคำถามประเภทใดอยู่แล้ว
  IF (SELECT COUNT(DISTINCT q.question_type) 
      FROM quiz_questions qq 
      JOIN questions q ON qq.question_id = q.question_id 
      WHERE qq.quiz_id = NEW.quiz_id) > 1 THEN
    RAISE EXCEPTION 'ไม่อนุญาตให้มีคำถามหลายประเภทในแบบทดสอบเดียวกัน';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- สร้าง trigger
CREATE TRIGGER trigger_check_quiz_question_types
  BEFORE INSERT ON quiz_questions
  FOR EACH ROW
  EXECUTE FUNCTION check_quiz_question_types();
```

---

### 4. หน้าเรียน บางครั้งข้อสอบก่อนเรียนขึ้นก่อน และคลิปเป็นดูเสร็จแล้ว

**ปัญหา:** ลำดับการแสดงผลและสถานะความก้าวหน้าไม่ถูกต้อง

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Courses/Learning.js` - ปรับปรุงฟังก์ชัน `updateSubjectProgress`
- `routes/Courses/Subjects.js` (บรรทัด 1705-1818) - แก้ไขการคำนวณ progress

**Database:**
- เพิ่ม field `is_prerequisite_completed` ใน `lesson_progress`
- ปรับปรุง logic การตรวจสอบเงื่อนไขเบื้องต้น

**แนวทางแก้ไข:**
```javascript
// เพิ่มการตรวจสอบเงื่อนไขเบื้องต้น
const checkPrerequisites = async (userId, lessonId, client) => {
  const result = await client.query(`
    SELECT 
      s.pre_test_id,
      qp.completed as pre_test_completed,
      qp.passed as pre_test_passed
    FROM lessons l
    JOIN subject_lessons sl ON l.lesson_id = sl.lesson_id
    JOIN subjects s ON sl.subject_id = s.subject_id
    LEFT JOIN quiz_progress qp ON s.pre_test_id = qp.quiz_id AND qp.user_id = $1
    WHERE l.lesson_id = $2
  `, [userId, lessonId]);
  
  const lesson = result.rows[0];
  
  // ถ้ามี pre-test และยังไม่ผ่าน ห้ามเข้าถึงบทเรียน
  if (lesson.pre_test_id && (!lesson.pre_test_completed || !lesson.pre_test_passed)) {
    return false;
  }
  return true;
};
```

---

### 5. เรียนเสร็จไม่ขึ้นให้ชำระเงินในส่วน dashboard

**ปัญหา:** หลังเรียนจบแล้วไม่แสดงตัวเลือกชำระเงิน

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/StudentPayments.js` (บรรทัด 86-182) - ปรับปรุงการตรวจสอบสถานะ
- `routes/Courses/Learning.js` - เพิ่มการอัปเดตสถานะชำระเงิน
- สร้างไฟล์ใหม่: `routes/Dashboard/PaymentStatus.js`

**Database:**
- เพิ่ม table `subject_completion_payments`
- ปรับปรุง table `enrollments` เพิ่ม field `payment_required`

**แนวทางแก้ไข:**
```sql
-- สร้างตารางใหม่สำหรับติดตามการชำระเงิน
CREATE TABLE subject_completion_payments (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(user_id),
  subject_id INTEGER REFERENCES subjects(subject_id),
  enrollment_id INTEGER REFERENCES enrollments(enrollment_id),
  completion_date TIMESTAMP,
  payment_required BOOLEAN DEFAULT true,
  payment_submitted BOOLEAN DEFAULT false,
  payment_approved BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, subject_id)
);
```

**API ที่ต้องเพิ่ม:**
1. `GET /api/dashboard/payment-status` - ดึงสถานะการชำระเงิน
2. `POST /api/dashboard/request-payment/:subjectId` - ขอชำระเงิน

---

### 6. ไม่สามารถเพิ่มรายวิชาในหลักสูตรได้

**ปัญหา:** อาจารย์ไม่สามารถเพิ่มวิชาได้

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Courses/Courses.js` - เพิ่ม endpoint สำหรับการจัดการรายวิชาในหลักสูตร
- `routes/Accounts/Instructors.js` (บรรทัด 1164-1245) - ปรับปรุงสิทธิ์การเข้าถึง

**Database:**
- ปรับปรุง table `course_subjects` เพิ่ม field สำหรับการจัดลำดับ
- เพิ่ม constraints สำหรับ authorization

**แนวทางแก้ไข:**
```javascript
// เพิ่ม endpoint ใหม่ใน Courses.js
router.post('/:courseId/subjects', authenticate, restrictTo(2,3,4), async (req, res) => {
  const { courseId } = req.params;
  const { subjectId, orderNumber } = req.body;
  const userId = req.user.id;
  
  // ตรวจสอบสิทธิ์ อาจารย์สามารถเพิ่มรายวิชาที่ตนสอนได้เท่านั้น
  const instructorCheck = await client.query(`
    SELECT si.instructor_id 
    FROM subject_instructors si
    JOIN instructors i ON si.instructor_id = i.instructor_id
    WHERE si.subject_id = $1 AND i.user_id = $2
  `, [subjectId, userId]);
  
  if (instructorCheck.rows.length === 0 && req.user.role_id === 2) {
    return res.status(403).json({
      success: false,
      message: 'คุณไม่มีสิทธิ์เพิ่มรายวิชานี้'
    });
  }
  
  // เพิ่มรายวิชาในหลักสูตร
  await client.query(`
    INSERT INTO course_subjects (course_id, subject_id, order_number)
    VALUES ($1, $2, $3)
    ON CONFLICT (course_id, subject_id) DO UPDATE
    SET order_number = $3
  `, [courseId, subjectId, orderNumber]);
});
```

---

### 7. แอดมินไม่สามารถสมัครแอคเค้าของนักเรียนได้

**ปัญหา:** กรอกข้อมูลครบและกดสมัครขึ้นว่า "ไม่ระบุประเภทการศึกษา"

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Accounts/School_Students.js` (บรรทัด 45-101) - แก้ไข validation
- `routes/register.js` - เพิ่ม field `education_type`

**Database:**
- เพิ่ม field `education_type` ใน table `students` หรือ `users`
- อัปเดต validation constraints

**แนวทางแก้ไข:**
```javascript
// ใน School_Students.js
const createStudentAccount = async (req, res) => {
  const {
    username,
    email,
    password,
    firstName,
    lastName,
    educationType, // เพิ่ม field นี้
    studentId,
    department
  } = req.body;
  
  // เพิ่ม validation
  if (!educationType) {
    return res.status(400).json({
      success: false,
      message: 'กรุณาระบุประเภทการศึกษา'
    });
  }
  
  // เพิ่มในการสร้าง student record
  await client.query(`
    INSERT INTO students (user_id, student_id, education_type, department_id)
    VALUES ($1, $2, $3, $4)
  `, [userId, studentId, educationType, department]);
};
```

---

### 8. แอดมินไม่สามารถสร้างหลักสูตร แก้ไขรายวิชา และสร้างรายวิชาได้

**ปัญหา:** ระบบไม่อนุญาตให้แอดมินจัดการหลักสูตรและรายวิชา

**ไฟล์ที่ต้องแก้ไข:**

**API Backend:**
- `routes/Courses/Courses.js` - เพิ่ม endpoints สำหรับแอดมิน
- `routes/Courses/Subjects.js` - เพิ่ม CRUD operations สำหรับแอดมิน
- `routes/Accounts/Admins.js` - เพิ่มฟังก์ชันการจัดการ

**Database:**
- ปรับปรุง role permissions ใน authentication middleware

**ไฟล์ที่ต้องสร้างใหม่:**
- `routes/Admin/CourseManagement.js`
- `routes/Admin/SubjectManagement.js`

**แนวทางแก้ไข:**
```javascript
// เพิ่มใน Courses.js
router.post('/', authenticate, restrictTo(1,4), async (req, res) => {
  // สร้างหลักสูตรใหม่ (เฉพาะแอดมิน)
});

router.put('/:id', authenticate, restrictTo(1,4), async (req, res) => {
  // แก้ไขหลักสูตร (เฉพาะแอดมิน)
});

// เพิ่มใน Subjects.js
router.post('/', authenticate, restrictTo(1,2,4), async (req, res) => {
  // สร้างรายวิชาใหม่ (แอดมิน, อาจารย์, ผู้จัดการ)
});

router.put('/:id', authenticate, restrictTo(1,2,4), async (req, res) => {
  // แก้ไขรายวิชา
});
```

---

## สรุปไฟล์ที่ต้องแก้ไขทั้งหมด

### Backend API Files:
1. `routes/Courses/Learning.js` - แก้ปัญหา 1, 4, 5
2. `routes/Courses/Lessons.js` - แก้ปัญหา 1, 4
3. `routes/Courses/SpecialQuiz.js` - แก้ปัญหา 2 (ตรวจสอบการแสดงสถานะ)
4. `routes/Courses/Questions.js` - แก้ปัญหา 3 (ป้องกันคำถามผสม)
5. `routes/Courses/Courses.js` - แก้ปัญหา 6, 8
6. `routes/Courses/Subjects.js` - แก้ปัญหา 4, 8
7. `routes/StudentPayments.js` - แก้ปัญหา 5
8. `routes/Accounts/School_Students.js` - แก้ปัญหา 7
9. `routes/Accounts/Instructors.js` - แก้ปัญหา 6
10. `routes/register.js` - แก้ปัญหา 7
11. Frontend components - แก้การแสดงสถานะ "รอตรวจ" ปัญหา 2

### Database Tables ที่ต้องปรับปรุง:
1. `lessons` - เพิ่ม order_number
2. `quiz_progress` - เพิ่ม awaiting_review
3. `lesson_progress` - เพิ่ม quiz_awaiting_review, is_prerequisite_completed
4. `quiz_questions` - เพิ่ม constraint ป้องกันคำถามผสม
5. `students` - เพิ่ม education_type
6. `course_subjects` - เพิ่ม order_number
7. สร้างตารางใหม่ `subject_completion_payments`

### Middleware ที่ต้องปรับปรุง:
1. `middleware/auth.js` - ปรับปรุง role permissions

---

## ลำดับการแก้ไข (แนะนำ)

1. **แก้ Database Schema** - ปรับปรุงตารางและเพิ่ม constraints
2. **แก้ Authentication & Authorization** - ปรับปรุงสิทธิ์การเข้าถึง
3. **แก้ปัญหาการเรียนรู้และนำทาง** (ปัญหา 1, 4)
4. **ตรวจสอบระบบ Special Quiz** (ปัญหา 2 - ระบบทำงานได้แล้ว แค่ตรวจ Frontend)
5. **ป้องกันแบบทดสอบผสม** (ปัญหา 3)
6. **แก้ปัญหาการจัดการหลักสูตร** (ปัญหา 6, 8)
7. **แก้ปัญหาการชำระเงิน** (ปัญหา 5)
8. **แก้ปัญหาการสมัครสมาชิก** (ปัญหา 7)

**หมายเหตุ:** ระบบ Special Quiz สำหรับการส่งไฟล์ทำงานได้แล้ว ไม่ต้องสร้างใหม่ แค่ตรวจสอบการแสดงสถานะ "รอตรวจ" ใน Frontend

การแก้ไขแต่ละปัญหาต้องทำการทดสอบอย่างละเอียดเพื่อให้แน่ใจว่าไม่กระทบกับฟังก์ชันอื่นๆ ในระบบ
